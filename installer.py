import shutil
import winreg
import os.path
from urllib.request import urlretrieve, urlopen
from inspect import cleandoc
from Settings import version_path

home = os.path.expandvars("%appdata%/MILC2")


def get_input(inp):
    return input(f"{inp}? > ")


def get_valid_input(inp, check, message):
    while check(output := get_input(inp)):
        print(message)
    return output


def create_send_to(path):
    with (winreg.CreateKey(winreg.HKEY_CLASSES_ROOT, rf"{path}\shell\MILC2")) as key:
        winreg.SetValueEx(key, "MUIVerb", None, winreg.REG_SZ, "Send to")
        winreg.SetValueEx(key, "subcommands", None, winreg.REG_SZ, "")
    with (winreg.CreateKey(winreg.HKEY_CLASSES_ROOT, rf"{path}\shell\MILC2\shell")): ...


def create_item(path, title, arg):
    # winreg.DeleteKey(winreg.HKEY_CLASSES_ROOT, rf"{path}\shell\MILC2")
    create_send_to(path)


if __name__ == "__main__":
    print("""
    
     /$$      /$$ /$$$$$$ /$$        /$$$$$$ 
    | $$$    /$$$|_  $$_/| $$       /$$__  $$
    | $$$$  /$$$$  | $$  | $$      | $$  \__/
    | $$ $$/$$ $$  | $$  | $$      | $$      
    | $$  $$$| $$  | $$  | $$      | $$      
    | $$\  $ | $$  | $$  | $$      | $$    $$
    | $$ \/  | $$ /$$$$$$| $$$$$$$$|  $$$$$$/
    |__/     |__/|______/|________/ \______/
            Mothers I'd Like to Calm
    
            
    """)

    print("Downloading MILC2...")

    if os.path.isdir(home):
        shutil.rmtree(home)
    os.mkdir(home)

    latest = urlopen("https://github.com/YoavShilon05/MILC2/releases/latest").geturl()

    urlretrieve(f"{latest}/download/MILC2.exe", f"{home}/MILC2.exe")
    urlretrieve(f"{latest}/download/MILC2.ico", f"{home}/MILC2.ico")
    with open(version_path, 'w') as f:
        f.write(latest.split('/')[-1])

    print("\nCreating settings...")

    def root_valid(o: str) -> bool:
        return not os.path.isdir(os.path.dirname(o.lstrip('\\/')))

    root = get_valid_input("Root directory", root_valid, "Invalid path").replace('/', '\\').rstrip('\\')
    if not os.path.isdir(root):
        os.mkdir(root)
    name = get_valid_input("Your name", lambda o: ' ' in o, "Spaces in names unsupported")
    ip = get_input("Remote IP")

    with open(f"{home}/settings.ini", 'w') as f:
        f.write(cleandoc(f"""
        [Settings]
        Root={root}
        Username={name}
        IP={ip}
        """))

    print("\nCreating context menu items...")
    create_item("*", "Send file", "%1")
    create_item("Directory", "Send folder", "%1")
    create_item("Directory\\Background", "Send folder", "%w")

    print("\nAdding MILC2 to startup...")
    os.system(r'schtasks /create /sc ONLOGON /tn MILC2 /tr "%appdata%\MILC2\MILC2.exe listen" /rl HIGHEST /f')

    print("\nAdding MILC2 to start menu")
    shortcut_data = b'L\x00\x00\x00\x01\x14\x02\x00\x00\x00\x00\x00\xc0\x00\x00\x00\x00\x00\x00F\x9b\x02\x08\x00 \x00\x00\x00\x94Ef\xce\x8dg\xd8\x01\xfb$\x9c:Uh\xd8\x01\xce\x84\xca\xd3\x8dg\xd8\x017\x8b\xac\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\x01:\x00\x1fDG\x1a\x03Yr?\xa7D\x89\xc5U\x95\xfek0\xee&\x00\x01\x00&\x00\xef\xbe\x10\x00\x00\x00\x92\xc1\xd5c\x9b\xf5\xd6\x01\x01\xf5\x15t7f\xd8\x01\x9f\x1b\x1c&Uh\xd8\x01\x14\x00\x82\x00t\x00\x1c\x00CFSF\x16\x001\x00\x00\x00\x00\x00<R\xea\x8b\x12\x00AppData\x00\x00\x00t\x1aY^\x96\xdf\xd3H\x8dg\x173\xbc\xee(\xba\xc5\xcd\xfa\xdf\x9fgVA\x89G\xc5\xc7k\xc0\xb6\x7f@\x00\t\x00\x04\x00\xef\xbe<R\xea\x8b\xafT\xf2\\.\x00\x00\x00"\xb5\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa6J\x18\x00A\x00p\x00p\x00D\x00a\x00t\x00a\x00\x00\x00B\x00V\x001\x00\x00\x00\x00\x00\xaeT\xc8\xa6\x10\x00Roaming\x00@\x00\t\x00\x04\x00\xef\xbe<R\xea\x8b\xafT\\].\x00\x00\x00#\xb5\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x8b\x1b#\x01R\x00o\x00a\x00m\x00i\x00n\x00g\x00\x00\x00\x16\x00P\x001\x00\x00\x00\x00\x00\xafT\x8ea\x10\x00MILC2\x00<\x00\t\x00\x04\x00\xef\xbe\xaeTHc\xafT\x8ea.\x00\x00\x00\xcf\xd4\x01\x00\x00\x00/\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x9c/\x01M\x00I\x00L\x00C\x002\x00\x00\x00\x14\x00\\\x002\x007\x8b\xac\x00\xaeTMc \x00MILC2.exe\x00D\x00\t\x00\x04\x00\xef\xbe\xaeTHc\xafT\xd5`.\x00\x00\x00\xbe\xfd\x01\x00\x00\x00?\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x002\xc0\xab\x00M\x00I\x00L\x00C\x002\x00.\x00e\x00x\x00e\x00\x00\x00\x18\x00\x00\x00]\x00\x00\x00\x1c\x00\x00\x00\x01\x00\x00\x00\x1c\x00\x00\x00-\x00\x00\x00\x00\x00\x00\x00\\\x00\x00\x00\x11\x00\x00\x00\x03\x00\x00\x00\xff\xc0\xdd\x08\x10\x00\x00\x00\x00C:\\Users\\yoavs\\AppData\\Roaming\\MILC2\\MILC2.exe\x00\x00\x0b\x00.\x00\\\x00M\x00I\x00L\x00C\x002\x00.\x00e\x00x\x00e\x00\x0f\x00%\x00a\x00p\x00p\x00d\x00a\x00t\x00a\x00%\x00\\\x00M\x00I\x00L\x00C\x002\x00`\x00\x00\x00\x03\x00\x00\xa0X\x00\x00\x00\x00\x00\x00\x00desktop-n397q44\x00\x10\x14\xb7T\xb0\xdfzJ\xa5\x86\x9a\xef=hRq\xc8)\x1ec\xca\xd3\xec\x11\x98"\x18\xc0Mh\xf6\x15\x10\x14\xb7T\xb0\xdfzJ\xa5\x86\x9a\xef=hRq\xc8)\x1ec\xca\xd3\xec\x11\x98"\x18\xc0Mh\xf6\x15E\x00\x00\x00\t\x00\x00\xa09\x00\x00\x001SPS\xb1\x16mD\xad\x8dpH\xa7H@.\xa4=x\x8c\x1d\x00\x00\x00h\x00\x00\x00\x00H\x00\x00\x00\xc8\xdd-Z\xdb\x01\xf5J\x85y_\xe4hg\xfc\xec\x00\x00\x00\x00\x00\x00\x00\x00\x14\x03\x00\x00\x01\x00\x00\xa0%appdata%\\MILC2\\MILC2.exe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00%\x00a\x00p\x00p\x00d\x00a\x00t\x00a\x00%\x00\\\x00M\x00I\x00L\x00C\x002\x00\\\x00M\x00I\x00L\x00C\x002\x00.\x00e\x00x\x00e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'

    with open("C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\MILC2.lnk", 'wb') as f:
        f.write(shortcut_data)

    print("\n\nDone! Launching MILC2...")
    os.system("schtasks /run /tn MILC2")
